import{r as u,j as s,c as S,b as Be,p as C,s as R,B as E,k as rt,o as at,l as xe,y as it}from"./index-jJ-r5mz2.js";import{b as He,n as lt,a as Oe}from"./use-scenario-CWX--LNn.js";import{C as _,b as ot,c as ct,a as ut,e as dt}from"./card-BJCnjeSF.js";import{D as ft,e as mt,f as gt,i as ye,A as je,n as ve,T as pt,H as be,I as Ne,J as we,u as ht}from"./avatar-CVUMpbYi.js";import{r as xt,i as yt,f as L,g as K,h as De,j as _e,J as jt,p as vt,v as bt,k as Nt,l as wt,n as At,o as We,q as St,s as kt,u as ce,t as D,w as Ve,x as Ae,M as ue,y as se,m as Ie,C as Se,T as Ct,a as Lt,b as Tt,c as Et,d as zt,e as Rt,z as Mt}from"./timeline-C83kdKd4.js";import{c as W,d as $e,e as Pt,f as Ft,g as Bt,h as Ht,i as Ot,S as Dt,a as _t,b as Wt}from"./scenario-file-dialogs-DxajuG-N.js";import{I as re,C as ae,c as Ge,d as qe,a as U,S as H,e as Qe,L as Vt}from"./use-log-Bf_Sl--R.js";import{B as ie}from"./badge-B4wrcvZ9.js";import{S as It,B as $t,T as Gt,a as qt,b as Qt,c as Ut}from"./tabs-CiAJZDg-.js";import{c as de}from"./index-DSZ_lwlW.js";import{u as Kt,C as Jt}from"./use-dind-DrplGUN9.js";import{I as Xt}from"./input-DJh99Cqt.js";import{C as Yt,S as Zt,a as es,b as ts,c as ss,e as ns,d as rs}from"./select-Da-KtjNO.js";import{S as as}from"./shield-B1QauJ3X.js";import{C as is}from"./index-CT9bT4NP.js";import"./createReactComponent-DA_aFz5i.js";import"./index-ZV2pxxac.js";import"./index-DC18PyZR.js";import"./index-Bdu6MxlU.js";import"./index-DcoZsgCb.js";import"./confirm-dialog-Br2qhugx.js";import"./form-BnuX5DB7.js";import"./search-C8RdyhLB.js";import"./IconTrash-CRDPUBDJ.js";import"./circle-alert-CnzQp5Ap.js";import"./index-BkDHe_rU.js";/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=[["path",{d:"m8 2 1.88 1.88",key:"fmnt4t"}],["path",{d:"M14.12 3.88 16 2",key:"qol33r"}],["path",{d:"M9 7.13v-1a3.003 3.003 0 1 1 6 0v1",key:"d7y7pr"}],["path",{d:"M12 20c-3.3 0-6-2.7-6-6v-3a4 4 0 0 1 4-4h4a4 4 0 0 1 4 4v3c0 3.3-2.7 6-6 6",key:"xs1cw7"}],["path",{d:"M12 20v-9",key:"1qisl0"}],["path",{d:"M6.53 9C4.6 8.8 3 7.1 3 5",key:"32zzws"}],["path",{d:"M6 13H2",key:"82j7cp"}],["path",{d:"M3 21c0-2.1 1.7-3.9 3.8-4",key:"4p0ekp"}],["path",{d:"M20.97 5c0 2.1-1.6 3.8-3.5 4",key:"18gb23"}],["path",{d:"M22 13h-4",key:"1jl80f"}],["path",{d:"M17.2 17c2.1.1 3.8 1.9 3.8 4",key:"k3fwyw"}]],os=de("bug",ls);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=[["path",{d:"M3.714 3.048a.498.498 0 0 0-.683.627l2.843 7.627a2 2 0 0 1 0 1.396l-2.842 7.627a.498.498 0 0 0 .682.627l18-8.5a.5.5 0 0 0 0-.904z",key:"117uat"}],["path",{d:"M6 12h16",key:"s4cdu5"}]],us=de("send-horizontal",cs);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],fs=de("triangle-alert",ds),G=new WeakMap;let q;const Ue=(e,t,r)=>(n,a)=>a&&a[0]?a[0][e+"Size"]:yt(n)&&"getBBox"in n?n.getBBox()[t]:n[r],ms=Ue("inline","width","offsetWidth"),gs=Ue("block","height","offsetHeight");function ps({target:e,borderBoxSize:t}){G.get(e)?.forEach(r=>{r(e,{get width(){return ms(e,t)},get height(){return gs(e,t)}})})}function hs(e){e.forEach(ps)}function xs(){typeof ResizeObserver>"u"||(q=new ResizeObserver(hs))}function ys(e,t){q||xs();const r=xt(e);return r.forEach(n=>{let a=G.get(n);a||(a=new Set,G.set(n,a)),a.add(t),q?.observe(n)}),()=>{r.forEach(n=>{const a=G.get(n);a?.delete(t),a?.size||q?.unobserve(n)})}}const Q=new Set;let M;function js(){M=()=>{const e={get width(){return window.innerWidth},get height(){return window.innerHeight}};Q.forEach(t=>t(e))},window.addEventListener("resize",M)}function vs(e){return Q.add(e),M||js(),()=>{Q.delete(e),!Q.size&&typeof M=="function"&&(window.removeEventListener("resize",M),M=void 0)}}function bs(e,t){return typeof e=="function"?vs(e):ys(e,t)}function Ke(e,t){let r;const n=()=>{const{currentTime:a}=t,l=(a===null?0:a.value)/100;r!==l&&e(l),r=l};return L.preUpdate(n,!0),()=>K(n)}function Ns(...e){const t=!Array.isArray(e[0]),r=t?0:-1,n=e[0+r],a=e[1+r],i=e[2+r],l=e[3+r],o=De(a,i,l);return t?o(n):o}function ws(e,t,r){const n=e.get();let a=null,i=n,l;const o=typeof n=="string"?n.replace(/[\d.-]/g,""):void 0,m=()=>{a&&(a.stop(),a=null)},f=()=>{m(),a=new jt({keyframes:[Ce(e.get()),Ce(i)],velocity:e.getVelocity(),type:"spring",restDelta:.001,restSpeed:.01,...r,onUpdate:l})};e.attach((g,y)=>(i=g,l=v=>y(ke(v,o)),L.postRender(f),e.get()),m);let d;return _e(t)&&(d=t.on("change",g=>e.set(ke(g,o))),e.on("destroy",d)),d}function ke(e,t){return t?e+t:e}function Ce(e){return typeof e=="number"?e:parseFloat(e)}function As(e,t,r){u.useInsertionEffect(()=>e.on(t,r),[e,t,r])}const Ss=50,Le=()=>({current:0,offset:[],progress:0,scrollLength:0,targetOffset:0,targetLength:0,containerLength:0,velocity:0}),ks=()=>({time:0,x:Le(),y:Le()}),Cs={x:{length:"Width",position:"Left"},y:{length:"Height",position:"Top"}};function Te(e,t,r,n){const a=r[t],{length:i,position:l}=Cs[t],o=a.current,m=r.time;a.current=e[`scroll${l}`],a.scrollLength=e[`scroll${i}`]-e[`client${i}`],a.offset.length=0,a.offset[0]=0,a.offset[1]=a.scrollLength,a.progress=vt(0,a.scrollLength,a.current);const f=n-m;a.velocity=f>Ss?0:bt(a.current-o,f)}function Ls(e,t,r){Te(e,"x",t,r),Te(e,"y",t,r),t.time=r}function Ts(e,t){const r={x:0,y:0};let n=e;for(;n&&n!==t;)if(Nt(n))r.x+=n.offsetLeft,r.y+=n.offsetTop,n=n.offsetParent;else if(n.tagName==="svg"){const a=n.getBoundingClientRect();n=n.parentElement;const i=n.getBoundingClientRect();r.x+=a.left-i.left,r.y+=a.top-i.top}else if(n instanceof SVGGraphicsElement){const{x:a,y:i}=n.getBBox();r.x+=a,r.y+=i;let l=null,o=n.parentNode;for(;!l;)o.tagName==="svg"&&(l=o),o=n.parentNode;n=l}else break;return r}const le={start:0,center:.5,end:1};function Ee(e,t,r=0){let n=0;if(e in le&&(e=le[e]),typeof e=="string"){const a=parseFloat(e);e.endsWith("px")?n=a:e.endsWith("%")?e=a/100:e.endsWith("vw")?n=a/100*document.documentElement.clientWidth:e.endsWith("vh")?n=a/100*document.documentElement.clientHeight:e=a}return typeof e=="number"&&(n=t*e),r+n}const Es=[0,0];function zs(e,t,r,n){let a=Array.isArray(e)?e:Es,i=0,l=0;return typeof e=="number"?a=[e,e]:typeof e=="string"&&(e=e.trim(),e.includes(" ")?a=e.split(" "):a=[e,le[e]?e:"0"]),i=Ee(a[0],r,n),l=Ee(a[1],t),i-l}const Rs={All:[[0,0],[1,1]]},Ms={x:0,y:0};function Ps(e){return"getBBox"in e&&e.tagName!=="svg"?e.getBBox():{width:e.clientWidth,height:e.clientHeight}}function Fs(e,t,r){const{offset:n=Rs.All}=r,{target:a=e,axis:i="y"}=r,l=i==="y"?"height":"width",o=a!==e?Ts(a,e):Ms,m=a===e?{width:e.scrollWidth,height:e.scrollHeight}:Ps(a),f={width:e.clientWidth,height:e.clientHeight};t[i].offset.length=0;let d=!t[i].interpolate;const g=n.length;for(let y=0;y<g;y++){const v=zs(n[y],f[l],m[l],o[i]);!d&&v!==t[i].interpolatorOffsets[y]&&(d=!0),t[i].offset[y]=v}d&&(t[i].interpolate=De(t[i].offset,wt(n),{clamp:!1}),t[i].interpolatorOffsets=[...t[i].offset]),t[i].progress=At(0,1,t[i].interpolate(t[i].current))}function Bs(e,t=e,r){if(r.x.targetOffset=0,r.y.targetOffset=0,t!==e){let n=t;for(;n&&n!==e;)r.x.targetOffset+=n.offsetLeft,r.y.targetOffset+=n.offsetTop,n=n.offsetParent}r.x.targetLength=t===e?t.scrollWidth:t.clientWidth,r.y.targetLength=t===e?t.scrollHeight:t.clientHeight,r.x.containerLength=e.clientWidth,r.y.containerLength=e.clientHeight}function Hs(e,t,r,n={}){return{measure:a=>{Bs(e,n.target,r),Ls(e,r,a),(n.offset||n.target)&&Fs(e,r,n)},notify:()=>t(r)}}const O=new WeakMap,ze=new WeakMap,ne=new WeakMap,Re=e=>e===document.scrollingElement?window:e;function Je(e,{container:t=document.scrollingElement,...r}={}){if(!t)return We;let n=ne.get(t);n||(n=new Set,ne.set(t,n));const a=ks(),i=Hs(t,e,a,r);if(n.add(i),!O.has(t)){const o=()=>{for(const g of n)g.measure(St.timestamp);L.preUpdate(m)},m=()=>{for(const g of n)g.notify()},f=()=>L.read(o);O.set(t,f);const d=Re(t);window.addEventListener("resize",f,{passive:!0}),t!==document.documentElement&&ze.set(t,bs(t,f)),d.addEventListener("scroll",f,{passive:!0}),f()}const l=O.get(t);return L.read(l,!1,!0),()=>{K(l);const o=ne.get(t);if(!o||(o.delete(i),o.size))return;const m=O.get(t);O.delete(t),m&&(Re(t).removeEventListener("scroll",m),ze.get(t)?.(),window.removeEventListener("resize",m))}}const Me=new Map;function Os(e){const t={value:0},r=Je(n=>{t.value=n[e.axis].progress*100},e);return{currentTime:t,cancel:r}}function Xe({source:e,container:t,...r}){const{axis:n}=r;e&&(t=e);const a=Me.get(t)??new Map;Me.set(t,a);const i=r.target??"self",l=a.get(i)??{},o=n+(r.offset??[]).join(",");return l[o]||(l[o]=!r.target&&kt()?new ScrollTimeline({source:t,axis:n}):Os({container:t,...r})),l[o]}function Ds(e,t){const r=Xe(t);return e.attachTimeline({timeline:t.target?void 0:r,observe:n=>(n.pause(),Ke(a=>{n.time=n.duration*a},r))})}function _s(e){return e.length===2}function Ws(e,t){return _s(e)?Je(r=>{e(r[t.axis].progress,r)},t):Ke(e,Xe(t))}function Vs(e,{axis:t="y",container:r=document.scrollingElement,...n}={}){if(!r)return We;const a={axis:t,container:r,...n};return typeof e=="function"?Ws(e,a):Ds(e,a)}const Is=()=>({scrollX:D(0),scrollY:D(0),scrollXProgress:D(0),scrollYProgress:D(0)}),$=e=>e?!e.current:!1;function $s({container:e,target:t,...r}={}){const n=ce(Is),a=u.useRef(null),i=u.useRef(!1),l=u.useCallback(()=>(a.current=Vs((o,{x:m,y:f})=>{n.scrollX.set(m.current),n.scrollXProgress.set(m.progress),n.scrollY.set(f.current),n.scrollYProgress.set(f.progress)},{...r,container:e?.current||void 0,target:t?.current||void 0}),()=>{a.current?.()}),[e,t,JSON.stringify(r.offset)]);return Ve(()=>{if(i.current=!1,$(e)||$(t)){i.current=!0;return}else return l()},[l]),u.useEffect(()=>{if(i.current)return Ae(!$(e)),Ae(!$(t)),l()},[l]),n}function J(e){const t=ce(()=>D(e)),{isStatic:r}=u.useContext(ue);if(r){const[,n]=u.useState(e);u.useEffect(()=>t.on("change",n),[])}return t}function Ye(e,t){const r=J(t()),n=()=>r.set(t());return n(),Ve(()=>{const a=()=>L.preRender(n,!1,!0),i=e.map(l=>l.on("change",a));return()=>{i.forEach(l=>l()),K(n)}}),r}function Gs(e){se.current=[],e();const t=Ye(se.current,e);return se.current=void 0,t}function oe(e,t,r,n){if(typeof e=="function")return Gs(e);const a=typeof t=="function"?t:Ns(t,r,n);return Array.isArray(e)?Pe(e,a):Pe([e],([i])=>a(i))}function Pe(e,t){const r=ce(()=>[]);return Ye(e,()=>{r.length=0;const n=e.length;for(let a=0;a<n;a++)r[a]=e[a].get();return t(r)})}function qs(e,t={}){const{isStatic:r}=u.useContext(ue),n=()=>_e(e)?e.get():e;if(r)return oe(n);const a=J(n());return u.useInsertionEffect(()=>ws(a,e,t),[a,JSON.stringify(t)]),a}function Qs(e){const t=u.useRef(0),{isStatic:r}=u.useContext(ue);u.useEffect(()=>{if(r)return;const n=({timestamp:a,delta:i})=>{t.current||(t.current=a),e(a-t.current,i)};return L.update(n,!0),()=>K(n)},[e])}function Us(e){const t=J(e.getVelocity()),r=()=>{const n=e.getVelocity();t.set(n),n&&L.update(r)};return As(e,"change",()=>{L.update(r,!1,!0)}),t}const Ks=(e,t,r)=>{const n=t-e;return((r-e)%n+n)%n+e},Js=({text:e,default_velocity:t=5,className:r})=>{const n=({children:a,baseVelocity:i=100,className:l})=>{const o=J(0),{scrollY:m}=$s(),f=Us(m),d=qs(f,{damping:50,stiffness:400}),g=oe(d,[0,1e3],[0,5],{clamp:!1}),[y,v]=u.useState(1),b=u.useRef(null),x=u.useRef(null);u.useEffect(()=>{const h=()=>{if(b.current&&x.current){const N=b.current.offsetWidth,V=x.current.offsetWidth,w=Math.ceil(N/V)+2;v(w)}};return h(),window.addEventListener("resize",h),()=>window.removeEventListener("resize",h)},[a]);const k=oe(o,h=>`${Ks(-100/y,0,h)}%`),j=u.useRef(1);return Qs(h=>{let N=j.current*i*(h/1e3);g.get()<0?j.current=-1:g.get()>0&&(j.current=1),N+=j.current*N*g.get(),o.set(o.get()+N)}),s.jsx("div",{className:"w-full overflow-hidden whitespace-nowrap",ref:b,children:s.jsx(Ie.div,{className:S("inline-block",l),style:{x:k},children:Array.from({length:y}).map((h,N)=>s.jsxs("span",{ref:N===0?x:null,children:[a," "]},N))})})};return s.jsx("section",{className:" w-full",children:s.jsx(n,{baseVelocity:t,className:r,children:e})})},Ze=u.forwardRef((e,t)=>{const{tabs:r=[],defaultActiveId:n=r[0]?.id,onTabChange:a,className:i,layoutId:l="pill-tabs-active-pill"}=e,[o,m]=u.useState(n),f=u.useCallback(d=>{m(d),a?.(d)},[a]);return u.useEffect(()=>{n&&m(n)},[n]),s.jsx("div",{ref:t,className:S("flex items-center gap-1 rounded-md p-1 bg-background border",i),children:r.map(d=>s.jsxs("button",{type:"button",onClick:()=>f(d.id),className:S("relative px-3 py-1.5 rounded-md transition touch-none","text-2xs font-medium",o===d.id?"text-primary-foreground":"text-muted-foreground hover:text-foreground"),children:[o===d.id&&s.jsx(Ie.div,{layoutId:l,className:"absolute inset-0 bg-primary rounded-md",transition:{type:"spring",duration:.5}}),s.jsx("span",{className:"relative z-10",children:d.label})]},d.id))})});Ze.displayName="PillTabs";function Xs(e){switch(e){case"INFO":return{Icon:re,color:"border-blue-500",levelName:"信息"};case"DEBUG":return{Icon:os,color:"border-gray-400",levelName:"调试"};case"WARNING":return{Icon:fs,color:"border-yellow-500",levelName:"警告"};case"ERROR":return{Icon:ae,color:"border-red-500",levelName:"错误"};case"CRITICAL":return{Icon:It,color:"border-red-700",levelName:"严重"};default:return{Icon:re,color:"border-gray-300",levelName:"未知"}}}const Ys=({item:e})=>{const{Icon:t,color:r,levelName:n}=Xs(e.level),[a,i]=u.useState(!1),o=(e.message.match(/\n/g)||[]).length+1>7||e.message.length>500,m=e.message.split(`
`).slice(0,5).join(`
`)+`
...`,f=o&&!a?m:e.message;return s.jsxs("div",{className:S("p-3 rounded-lg border-l-4 bg-card shadow-sm",r),children:[s.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[s.jsx(t,{className:"h-5 w-5 flex-shrink-0"}),s.jsx("span",{className:"font-semibold text-sm",children:n}),e.type==="history"&&s.jsx(ie,{variant:"outline",className:"text-xs font-normal",children:"历史记录"}),s.jsx("span",{className:"text-xs text-muted-foreground ml-auto",children:new Date(e.timestamp).toLocaleTimeString()})]}),s.jsxs("div",{className:"pl-8 text-sm break-words",children:[s.jsx("p",{className:"whitespace-pre-wrap  text-xs",children:f}),o&&s.jsx("button",{type:"button",onClick:()=>i(d=>!d),className:"mt-2 text-sm font-semibold text-blue-500 hover:underline focus:outline-none",children:a?"收起":"展开"})]})]})},Zs=({logs:e})=>{const t=u.useRef(null),[r,n]=u.useState(!0),a=u.useRef(null),i=u.useCallback(()=>{t.current&&(t.current.scrollTop=t.current.scrollHeight)},[]);return u.useEffect(()=>{r&&i()},[e,r,i]),u.useEffect(()=>{const l=t.current;if(!l)return;const o=()=>{a.current&&window.clearTimeout(a.current),l.scrollHeight-l.scrollTop-l.clientHeight<10?n(!0):(n(!1),a.current=window.setTimeout(()=>{n(!0)},5e3))};return l.addEventListener("scroll",o,{passive:!0}),()=>{l.removeEventListener("scroll",o),a.current&&window.clearTimeout(a.current)}},[i]),s.jsx("div",{className:"relative h-full w-full bg-background",children:s.jsxs("div",{ref:t,className:"h-full w-full overflow-y-auto p-4 space-y-4",children:[e.map(l=>s.jsx(Ys,{item:l},l.id)),e.length===0&&s.jsx("div",{className:"flex h-full items-center justify-center",children:s.jsx("p",{className:"text-muted-foreground",children:"等待接收日志..."})})]})})},en=({modelId:e,className:t})=>{const{logs:r,startLogs:n,isStreaming:a}=Ge(e),{scenarioProcessState:i}=W(),{logs:l,startLogs:o,isStreaming:m}=qe(e),{status:f,statusQuery:d}=$e(e),[g,y]=u.useState("attacker-agent-log"),[v,b]=u.useState(!1);if(u.useEffect(()=>{const k=d.isSuccess&&!d.isError&&f?.initialized&&!i.isAttackFinished;b(k||!1),k&&(g==="attacker-agent-log"&&!a&&r.length===0?n({user_id:e}):g==="defender-agent-log"&&!m&&l.length===0&&o({model_id:e}))},[g,a,r.length,n,m,l.length,o,e,d.isSuccess,d.isError,f?.initialized,i.isAttackFinished]),i.isAttackFinished)return s.jsx("div",{className:"flex h-full w-full items-center justify-center",children:s.jsx("p",{className:"text-lg text-primary",children:"攻击已结束，指挥官可以与攻击Agent对话，或者直接开始生成报告"})});const x=g==="attacker-agent-log"?r.slice(-25):l.slice(-25);return s.jsxs(_,{className:S("flex h-full w-full flex-col shadow-lg rounded-xl",t),children:[s.jsxs("div",{className:"flex items-center justify-between p-4 border-b",children:[s.jsx("h2",{className:"text-lg font-semibold",children:"Agent实时日志"}),s.jsx(Ze,{tabs:[{id:"attacker-agent-log",label:"攻击方"},{id:"defender-agent-log",label:"防御方"}],defaultActiveId:g,onTabChange:y,layoutId:"agent-log-controller-tabs"})]}),s.jsx("div",{className:"flex-1 min-h-0 p-2",children:v?s.jsx(Zs,{logs:x}):s.jsx("div",{className:"h-full w-full flex items-center justify-center",children:s.jsx(U,{})})})]})},tn="sk-f83f79774f004dbf8df08125bf01e3fb";function sn({className:e,scenarioId:t}){const{portMap:r,attackerContainerName:n,targetContainerName:a,defenderContainerName:i,targetContainer:l,ipAddressMap:o,isPending:m,isSuccess:f}=He(t),{messages:d,setMessages:g,input:y,handleInputChange:v,handleSubmit:b,isLoading:x,sendMessage:k,setBoxType:j}=Pt({user_id:t}),{status:h,initUserAsync:N,cleanupUserAsync:V}=$e(t),{status:w,initInstanceAsync:I,cleanupInstanceAsync:X}=Ft(t),{dindPackageInfo:p}=Kt(t),{setScenarioProcessState:A,scenarioProcessState:z}=W(),{readmeContent:fe}=lt(t),et=Be(),[tt,me]=u.useState(!1),P=u.useRef(null),[ge,Y]=u.useState(!0),F=u.useRef(null),Z=u.useCallback(()=>{P.current&&(P.current.scrollTop=P.current.scrollHeight)},[]);u.useEffect(()=>{ge&&Z()},[d,ge,Z]),u.useEffect(()=>{const c=P.current;if(!c)return;const T=()=>{F.current&&window.clearTimeout(F.current),c.scrollHeight-c.scrollTop-c.clientHeight<10?Y(!0):(Y(!1),F.current=window.setTimeout(()=>{Y(!0)},5e3))};return c.addEventListener("scroll",T,{passive:!0}),()=>{c.removeEventListener("scroll",T),F.current&&window.clearTimeout(F.current)}},[Z]);const ee=r.get(i)?`http://localhost:${r.get(i)?.mcpPort}/sse`:void 0,te=r.get(n)?`http://localhost:${r.get(n)?.mcpPort}/sse`:void 0,B=r.get(a)&&o.get(a)?`http://${o.get(a)}:8080`:void 0,st="当前靶机地址为:"+B+"请开始黑盒攻击",nt="当前靶机地址为:"+B+`
白盒信息为:`+fe+`
请开始白盒攻击`,pe=(c,T)=>{k(c,T),me(!1),A(he=>({...he,isAttackStarted:!0}))};return u.useEffect(()=>{h&&!h.initialized&&te&&B&&f&&!z.isAttackFinished?N({data:{api_key:tn,user_id:t,attacker_server_url:te,target_entrance_url:B}}).then(c=>{c.code==200&&(C("攻击Agent初始化成功"),A(T=>({...T,attackAgentInitialized:!0}))),c&&c.code===1001&&R(c.message||"攻击Agent初始化失败")}).catch(c=>{R(c?.message||"攻击Agent初始化失败")}):h&&h.initialized&&A(c=>({...c,attackAgentInitialized:!0}))},[h?.initialized,t,te,B,f,z.isAttackFinished]),u.useEffect(()=>{w&&!w.initialized&&p&&ee&&f&&!z.isAttackFinished?I({model_id:t,container_pcap_mapping:p,mcp_server_url:ee}).then(c=>{c.code==200&&(C(c.message||"防御Agent初始化成功"),A(T=>({...T,defenseAgentInitialized:!0}))),c&&c.code===1001&&R(c.message||"防御Agent初始化失败")}):w&&w.initialized&&A(c=>({...c,defenseAgentInitialized:!0}))},[w?.initialized,t,p,ee,f,z.isAttackFinished]),u.useEffect(()=>{d.length>0&&A(c=>({...c,isAttackStarted:!0})),h?.initialized&&d.length===0&&me(!0)},[h?.initialized,d.length]),m?s.jsx("div",{className:"flex h-full w-full items-center justify-center p-4 shadow-xs",children:s.jsx(U,{})}):s.jsxs(_,{className:S("flex flex-col pt-2",e),children:[s.jsxs(ot,{className:"flex flex-col gap-3 pt-3 pb-2",children:[s.jsxs("div",{className:"flex items-center justify-between gap-3",children:[s.jsx(ct,{className:"text-base font-semibold text-foreground",children:"Agent 状态监控"}),s.jsxs(ft,{children:[s.jsx(mt,{asChild:!0,children:s.jsx(E,{variant:"outline",size:"sm",className:"h-7 w-7 p-0",children:s.jsx(Yt,{className:"h-3 w-3"})})}),s.jsxs(gt,{align:"end",className:"w-48",children:[s.jsx(ye,{asChild:!0,children:s.jsx(E,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:()=>{localStorage.removeItem(`attacker-agent-${t}`),g([])},children:"清除本地消息"})}),s.jsx(ye,{asChild:!0,children:s.jsx(E,{variant:"ghost",size:"sm",className:"w-full justify-start",onClick:()=>{V({params:{user_id:t}}).then(c=>{c.code==200&&C(c.message||"攻击Agent实例清除成功"),c&&c.code===1001&&R(c.message||"攻击Agent实例清除失败")}).catch(c=>{R(c?.message||"攻击Agent初始化失败")}),X().then(c=>{c.code==200&&C(c.message||"防御Agent实例清除成功"),c&&c.code===1001&&R(c.message||"防御Agent实例清除失败")}),localStorage.removeItem(`attacker-agent-${t}`),g([]),et({to:"/scenarios"})},children:"清除Agent实例"})})]})]})]}),s.jsxs("div",{className:"flex items-center justify-between w-full",children:[s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx($t,{className:"h-4 w-4 text-primary"}),s.jsx(ie,{variant:h?.initialized?"default":"secondary",className:S("flex items-center gap-1 px-2 py-1 text-xs",h?.initialized?"bg-primary text-primary-foreground":"bg-muted text-muted-foreground"),children:h?.initialized?s.jsxs(s.Fragment,{children:[s.jsx(Se,{className:"h-3 w-3"}),"已初始化"]}):s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"h-3 w-3"}),"未初始化"]})})]}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsx(as,{className:"h-4 w-4 text-secondary"}),s.jsx(ie,{variant:w?.initialized?"default":"secondary",className:S("flex items-center gap-1 px-2 py-1 text-xs",w?.initialized?"bg-secondary text-secondary-foreground":"bg-muted text-muted-foreground"),children:w?.initialized?s.jsxs(s.Fragment,{children:[s.jsx(Se,{className:"h-3 w-3"}),"已初始化"]}):s.jsxs(s.Fragment,{children:[s.jsx(ae,{className:"h-3 w-3"}),"未初始化"]})})]})]})]}),s.jsxs(ut,{className:"flex min-h-0 flex-1 flex-col px-4",children:[s.jsx("div",{ref:P,className:"flex-1 overflow-y-auto min-h-0",children:s.jsxs("div",{className:"space-y-4",children:[d.length===0&&s.jsx("div",{className:"text-muted-foreground flex h-full items-center justify-center",children:"开始与 Attacker Agent 对话"}),d.map(c=>s.jsxs("div",{className:S("flex items-start gap-3",c.role==="user"?"justify-end":"justify-start"),children:[c.role!=="user"&&s.jsx(je,{className:"h-8 w-8 bg-primary/10 border border-primary/20",children:s.jsx(ve,{className:"text-primary text-sm font-medium",children:"AI"})}),s.jsx("div",{className:S("max-w-[75%] rounded-lg px-3 py-2 text-sm shadow-sm",c.role==="user"?"bg-primary text-primary-foreground":"bg-muted text-foreground border border-border"),children:s.jsx("p",{className:"break-words whitespace-pre-wrap",children:c.content})}),c.role==="user"&&s.jsx(je,{className:"h-8 w-8 bg-accent/10 border border-accent/20",children:s.jsx(ve,{className:"text-accent text-sm font-medium",children:"我"})})]},c.id))]})}),tt&&s.jsxs("div",{className:"mt-4 p-4 bg-muted/30 rounded-lg border border-border",children:[s.jsx("p",{className:"text-foreground mb-3 text-center text-sm font-medium",children:"选择一个模式开始："}),s.jsxs("div",{className:"flex justify-center gap-3",children:[s.jsx(E,{variant:"outline",size:"sm",className:"flex-1 max-w-32",onClick:()=>{j("black"),pe(st)},children:"黑盒攻击"}),s.jsx(E,{variant:"outline",size:"sm",className:"flex-1 max-w-32",onClick:()=>{j("white"),pe(nt,fe??JSON.stringify(l))},children:"白盒攻击"})]})]})]}),s.jsx(dt,{className:"border-t bg-muted/20",children:s.jsxs("form",{onSubmit:b,className:"flex w-full items-center gap-2",children:[s.jsx(Xt,{value:y,onChange:v,placeholder:"与智能体对话...",disabled:x,autoFocus:!0,className:"flex-1"}),s.jsxs(E,{type:"submit",disabled:x||!y.trim(),size:"sm",className:"px-3",children:[s.jsx(us,{className:"h-4 w-4"}),s.jsx("span",{className:"sr-only",children:"发送"})]})]})})]})}const Fe=[{id:"attacker",label:"攻击机"},{id:"defender",label:"防御机"},{id:"target",label:"靶机"}],nn=[{label:"全部",value:"ALL"},{label:"Info",value:H.INFO},{label:"Warning",value:H.WARNING},{label:"Error",value:H.ERROR},{label:"Debug",value:H.DEBUG},{label:"Critical",value:H.CRITICAL}],rn=({modelId:e})=>{const{portMap:t,ipAddressMap:r,statusMap:n,attackerContainerName:a,defenderContainerName:i,targetContainerName:l,isPending:o}=He(e),{containerLogs:m,createContainerConnection:f,closeContainerConnection:d}=Qe(),[g,y]=u.useState("ALL"),[v,b]=u.useState("attacker"),{scenarioProcessState:x}=W();u.useEffect(()=>{const A={attacker:a,defender:i,target:l}[v];if(!x.isAttackFinished&&A)return f(e,A),()=>{d(e,A)}},[e,v,a,i,l,f,d,x.isAttackFinished]);const j={attacker:a,defender:i,target:l}[v],h=j?`${e}-${j}`:"",N=m[h]?.logs??[],w=N.filter(p=>g==="ALL"?!0:p.level===g).slice(-25),I=m[h]?.connectionState??"Waiting...";if(o)return s.jsx(_,{className:"flex h-full w-full items-center justify-center p-4 shadow-xs",children:s.jsx(U,{})});const X=()=>{if(!j)return null;const p=n.get(j),A=r.get(j),z=t.get(j);return s.jsxs("div",{className:"text-muted-foreground grid grid-cols-2 gap-x-4 gap-y-1 text-sm",children:[s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"状态:"})," ",p?.status??"N/A"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"IP:"})," ",A??"N/A"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"MCP 端口:"})," ",z?.mcpPort??"N/A"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"SSH 端口:"})," ",z?.sshPort??"N/A"]}),s.jsxs("p",{children:[s.jsx("span",{className:"font-semibold",children:"SSE 状态:"})," ",I]})]})};return s.jsx(pt,{children:s.jsx(_,{className:"bg-card text-card-foreground flex h-full w-full flex-col rounded-md shadow-xs py-0",children:s.jsxs(Gt,{value:v,onValueChange:p=>b(p),className:"flex h-full w-full flex-col",children:[s.jsxs("div",{className:"border-border bg-background flex items-center justify-between border-b p-2",children:[s.jsx(qt,{className:"grid w-fit grid-cols-3",children:Fe.map(p=>s.jsx(Qt,{value:p.id,children:p.label},p.id))}),s.jsxs("div",{className:"flex items-center gap-2",children:[s.jsxs(Zt,{value:g,onValueChange:p=>y(p),children:[s.jsx(es,{className:"w-[120px]",children:s.jsx(ts,{placeholder:"Log level"})}),s.jsx(ss,{children:s.jsx(ns,{children:nn.map(p=>s.jsx(rs,{value:p.value,children:p.label},p.value))})})]}),s.jsxs(be,{children:[s.jsx(Ne,{asChild:!0,children:s.jsx(E,{variant:"ghost",size:"icon",onClick:()=>{j&&(navigator.clipboard.writeText(j),C("容器名已复制"))},disabled:!j,children:s.jsx(Jt,{size:16})})}),s.jsx(we,{children:s.jsx("p",{children:"复制容器名"})})]}),s.jsxs(be,{children:[s.jsx(Ne,{asChild:!0,children:s.jsx(E,{variant:"ghost",size:"icon",disabled:!j,children:s.jsx(re,{size:16})})}),s.jsx(we,{children:s.jsx("p",{children:"查看详情"})})]})]})]}),s.jsx("div",{className:"flex-1 min-h-0",children:Fe.map(p=>s.jsx(Ut,{value:p.id,className:"h-full w-full",children:I==="connecting"&&N.length===0?s.jsx("div",{className:"flex h-full items-center justify-center",children:s.jsx(U,{})}):x.isAttackFinished?s.jsx("div",{className:"flex h-full items-center justify-center",children:s.jsx("p",{className:"text-lg text-primary",children:"攻击结束，各容器的日志流已关闭"})}):s.jsx(Vt,{logs:w,className:"h-full p-2"})},p.id))}),s.jsx("div",{className:"border-border bg-background border-t p-3",children:X()})]})})})},an=rt.create({baseURL:"/assessment",timeout:1e4,headers:{"Content-Type":"application/json"}});an.interceptors.response.use(e=>e.data,e=>Promise.reject(e));const ln=(e,t)=>{const r=at(),{refetchStatus:n=!0}=t??{},a=!!e&&n,i=["defender-report-status",e],l=["defender-report",e],o=()=>{e&&(r.invalidateQueries({queryKey:i}),r.invalidateQueries({queryKey:l}))},m=Bt(),f=Ht(),{data:d}=xe({queryKey:i,queryFn:async()=>e?(await m.mutateAsync({data:{model_id:e}})).data??null:null,enabled:a,refetchInterval:x=>n&&x.state.data?.is_complete===!1?1e4:!1}),{data:g,isPending:y,isSuccess:v}=xe({queryKey:l,queryFn:async()=>e?(await f.mutateAsync({data:{model_id:e}})).data??null:null,enabled:a&&d?.status==="completed"}),b=Ot({mutation:{onSuccess:x=>{o(),C(x.message??"已开始生成防御报告，请稍后")},onError:x=>{R("报告生成请求失败",x.detail?.map(k=>k.msg).join(", ")??"未知错误")}}});return e?{status:d,report:g,isPending:y,isSuccess:v,analyze:()=>{b.mutate({data:{model_id:e}})},analyzeAsync:()=>b.mutateAsync({data:{model_id:e}}),isAnalyzing:b.isPending}:{status:null,report:null,isPending:!1,analyze:()=>{},analyzeAsync:async()=>Promise.resolve({}),isAnalyzing:!1}};function on({lineItems:e,currentStep:t,className:r}){return s.jsx(Ct,{defaultValue:0,value:t,orientation:"horizontal",className:r,children:e.map(n=>s.jsxs(Lt,{step:n.id,className:"group-data-[orientation=horizontal]/timeline:mt-0",children:[s.jsxs(Tt,{children:[s.jsx(Et,{className:"group-data-[orientation=horizontal]/timeline:top-8"}),s.jsx("div",{className:"text-muted-foreground mb-10 block text-xs font-medium group-data-[orientation=vertical]/timeline:max-sm:h-4",children:n.purpose??" "}),s.jsx(zt,{children:n.title}),s.jsx(Rt,{className:"group-data-completed/timeline-item:bg-primary group-data-completed/timeline-item:text-primary-foreground flex size-6 items-center justify-center group-data-completed/timeline-item:border-none group-data-[orientation=horizontal]/timeline:top-8",children:s.jsx(is,{className:"group-not-data-completed/timeline-item:hidden",size:16})})]}),s.jsxs(Mt,{className:"flex gap-2 font-serif",children:[s.jsx("div",{children:n.description}),n.action&&s.jsx("div",{className:"text-primary hover:text-primary/80 group-not-data-completed/timeline-item:pointer-events-none:cursor-not-allowed cursor-pointer underline group-not-data-completed/timeline-item:pointer-events-none group-not-data-completed/timeline-item:hidden",onClick:n.action?.onClick,children:n.action?.label})]})]},n.id))})}function cn({scenarioId:e,className:t}){const r=Be(),{step:n,setScenarioProcessState:a,scenarioProcessState:i}=W(),{status:l}=ln(e,{refetchStatus:i.isAttackFinished}),{stopLogs:o}=Ge(e),{stopLogs:m}=qe(e),{closeAllContainerConnection:f}=Qe();u.useEffect(()=>{i.isAttackFinished&&l?.status==="completed"&&(a(g=>({...g,isReportGenerated:!0})),C("演练报告生成成功"))},[l?.status,i.isAttackFinished]);const d=[{id:1,title:"实例化agent",purpose:"初始化攻击/防御agent",description:"攻击/防御agent实例化完成"},{id:2,title:"开始攻击",purpose:"指挥官下达攻击指令",description:"指挥官指示Agent进行黑盒/白盒攻击,攻击一段时间后,Agent会自行判断是否攻击完毕，指挥官也可以自行手动停止攻击->",action:{label:"停止攻击",onClick:()=>{o(),m(),f(e),a(g=>({...g,isAttackFinished:!0}))}}},{id:3,title:"演练周期结束",purpose:"Agent攻防演练周期结束",description:"攻击/防御agent结束，指挥官可以与攻击Agent进行对话，但不会对靶机进行攻击,或者可以直接开始生成演练报告->",action:{label:"生成演练报告",onClick:()=>{C("正在生成报告，请稍后"),setTimeout(()=>{a(g=>({...g,isReportGenerated:!0})),C("演练报告生成成功")},5e3)}}},{id:4,title:"演练报告生成",purpose:"用于溯源、复盘",description:"防御演练报告已生成，演练结束->",action:{label:"查看演练报告",onClick:()=>{r({to:"/scenarios/$scenarioId/report",params:{scenarioId:e}})}}}];return s.jsx(on,{lineItems:d,currentStep:n,className:S(t,"no-scrollbar overflow-y-auto")})}const un=({scenarioId:e})=>{const{status:t,scenario:r}=Oe(e),{scenarioProcessState:n}=W(),a=n.isAttackStarted;return r?(t&&(r.state=t.state),s.jsxs("div",{className:`flex ${a?"h-[175vh]":"h-screen"} flex-col transition-all duration-700 ease-in-out`,children:[s.jsx("div",{className:"h-screen flex-shrink-0",children:s.jsxs("div",{className:"flex h-full w-full gap-2",children:[s.jsx("div",{className:"w-1/3",children:s.jsx(sn,{scenarioId:e,className:"h-full w-full"})}),s.jsxs(_,{className:"flex h-full w-2/3 flex-col py-0",children:[s.jsxs("div",{className:"flex h-2/3 w-full flex-col gap-2 p-10",children:[s.jsx(cn,{scenarioId:e,className:"mt-0 h-1/2"}),s.jsx(Js,{text:"TARGET SAFE",className:"text-2xl text-green-600"})]}),s.jsx("div",{className:"flex h-2/5 w-full flex-col gap-2 rounded-b-lg",children:s.jsx(rn,{modelId:e})})]})]})}),a&&s.jsx(en,{modelId:e,className:"h-[75vh] flex-col"})]})):s.jsx("div",{className:"text-muted-foreground p-4 text-center",children:"场景加载中..."})},dn=({scenarioId:e})=>{const{scenario:t}=Oe(e),{open:r,setOpen:n}=ht();return u.useEffect(()=>(r&&n(!1),()=>{r||n(!0)}),[r,n]),t?s.jsxs(Dt,{children:[s.jsx(un,{scenarioId:e}),s.jsx(_t,{}),s.jsx(Wt,{})]}):s.jsx("div",{className:"text-muted-foreground p-4 text-center",children:"场景未找到。"})},On=function(){const{scenarioId:t}=it.useParams();return s.jsx(dn,{scenarioId:t})};export{On as component};
