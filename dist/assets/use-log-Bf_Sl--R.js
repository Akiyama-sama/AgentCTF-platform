import{c as D}from"./index-DSZ_lwlW.js";import{r,j as h,c as w,B as K}from"./index-jJ-r5mz2.js";import{X as Z}from"./index-ZV2pxxac.js";import{C as X}from"./circle-alert-CnzQp5Ap.js";/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Q=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m15 9-6 6",key:"1uzhvr"}],["path",{d:"m9 9 6 6",key:"z0biqf"}]],Ae=D("circle-x",Q);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=[["path",{d:"M10 12v-1",key:"v7bkov"}],["path",{d:"M10 18v-2",key:"1cjy8d"}],["path",{d:"M10 7V6",key:"dljcrl"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M15.5 22H18a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v16a2 2 0 0 0 .274 1.01",key:"gkbcor"}],["circle",{cx:"10",cy:"20",r:"2",key:"1xzdoj"}]],te=D("file-archive",ee);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M8 13h2",key:"yr2amv"}],["path",{d:"M14 13h2",key:"un5t4a"}],["path",{d:"M8 17h2",key:"2yhykz"}],["path",{d:"M14 17h2",key:"10kma7"}]],se=D("file-spreadsheet",ne);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M10 9H8",key:"b1mrlr"}],["path",{d:"M16 13H8",key:"t4e002"}],["path",{d:"M16 17H8",key:"z1uh3a"}]],re=D("file-text",oe);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ae=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}],["path",{d:"M12 12v6",key:"3ahymv"}],["path",{d:"m15 15-3-3-3 3",key:"15xj92"}]],ce=D("file-up",ae);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z",key:"1rqfz7"}],["path",{d:"M14 2v4a2 2 0 0 0 2 2h4",key:"tnqrlb"}]],U=D("file",ie);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const le=[["path",{d:"M3 14h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-7a9 9 0 0 1 18 0v7a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3",key:"1xhozi"}]],ue=D("headphones",le);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const de=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",ry:"2",key:"1m3agn"}],["circle",{cx:"9",cy:"9",r:"2",key:"af1f0g"}],["path",{d:"m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21",key:"1xmnt7"}]],ge=D("image",de);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const me=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M12 16v-4",key:"1dtifu"}],["path",{d:"M12 8h.01",key:"e9boi3"}]],we=D("info",me);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const he=[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]],fe=D("loader-circle",he);/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const pe=[["path",{d:"m16 13 5.223 3.482a.5.5 0 0 0 .777-.416V7.87a.5.5 0 0 0-.752-.432L16 10.5",key:"ftymec"}],["rect",{x:"2",y:"6",width:"14",height:"12",rx:"2",key:"158x01"}]],ye=D("video",pe),Se=(t={})=>{const{maxFiles:e=1/0,maxSize:n=1/0,accept:g="*",multiple:o=!1,initialFiles:m=[],onFilesChange:l,onFilesAdded:u}=t,[c,a]=r.useState({files:m.map(s=>({file:s,id:s.id,preview:s.url})),isDragging:!1,errors:[]}),i=r.useRef(null),O=r.useCallback(s=>{if(s instanceof File){if(s.size>n)return`File "${s.name}" exceeds the maximum size of ${_(n)}.`}else if(s.size>n)return`File "${s.name}" exceeds the maximum size of ${_(n)}.`;if(g!=="*"){const v=g.split(",").map(R=>R.trim()),N=s instanceof File?s.type||"":s.type,I=`.${s instanceof File,s.name.split(".").pop()}`;if(!v.some(R=>{if(R.startsWith("."))return I.toLowerCase()===R.toLowerCase();if(R.endsWith("/*")){const B=R.split("/")[0];return N.startsWith(`${B}/`)}return N===R}))return`File "${s instanceof File,s.name}" is not an accepted file type.`}return null},[g,n]),p=r.useCallback(s=>s instanceof File?URL.createObjectURL(s):s.url,[]),f=r.useCallback(s=>s instanceof File?`${s.name}-${Date.now()}-${Math.random().toString(36).substring(2,9)}`:s.id,[]),S=r.useCallback(()=>{a(s=>{s.files.forEach(N=>{N.preview&&N.file instanceof File&&N.file.type.startsWith("image/")&&URL.revokeObjectURL(N.preview)}),i.current&&(i.current.value="");const v={...s,files:[],errors:[]};return l?.(v.files),v})},[l]),d=r.useCallback(s=>{if(!s||s.length===0)return;const v=Array.from(s),N=[];if(a(x=>({...x,errors:[]})),o||S(),o&&e!==1/0&&c.files.length+v.length>e){N.push(`You can only upload a maximum of ${e} files.`),a(x=>({...x,errors:N}));return}const I=[];v.forEach(x=>{if(o&&c.files.some(G=>G.file.name===x.name&&G.file.size===x.size))return;if(x.size>n){N.push(o?`Some files exceed the maximum size of ${_(n)}.`:`File exceeds the maximum size of ${_(n)}.`);return}const R=O(x);R?N.push(R):I.push({file:x,id:f(x),preview:p(x)})}),I.length>0?(u?.(I),a(x=>{const R=o?[...x.files,...I]:I;return l?.(R),{...x,files:R,errors:N}})):N.length>0&&a(x=>({...x,errors:N})),i.current&&(i.current.value="")},[c.files,e,o,n,O,p,f,S,l,u]),y=r.useCallback(s=>{a(v=>{const N=v.files.find(x=>x.id===s);N&&N.preview&&N.file instanceof File&&N.file.type.startsWith("image/")&&URL.revokeObjectURL(N.preview);const I=v.files.filter(x=>x.id!==s);return l?.(I),{...v,files:I,errors:[]}})},[l]),E=r.useCallback(()=>{a(s=>({...s,errors:[]}))},[]),A=r.useCallback(s=>{s.preventDefault(),s.stopPropagation(),a(v=>({...v,isDragging:!0}))},[]),q=r.useCallback(s=>{s.preventDefault(),s.stopPropagation(),!s.currentTarget.contains(s.relatedTarget)&&a(v=>({...v,isDragging:!1}))},[]),P=r.useCallback(s=>{s.preventDefault(),s.stopPropagation()},[]),V=r.useCallback(s=>{if(s.preventDefault(),s.stopPropagation(),a(v=>({...v,isDragging:!1})),!i.current?.disabled&&s.dataTransfer.files&&s.dataTransfer.files.length>0)if(o)d(s.dataTransfer.files);else{const v=s.dataTransfer.files[0];d([v])}},[d,o]),M=r.useCallback(s=>{s.target.files&&s.target.files.length>0&&d(s.target.files)},[d]),J=r.useCallback(()=>{i.current&&i.current.click()},[]),Y=r.useCallback((s={})=>({...s,type:"file",onChange:M,accept:s.accept||g,multiple:s.multiple!==void 0?s.multiple:o,ref:i}),[g,o,M]);return[c,{addFiles:d,removeFile:y,clearFiles:S,clearErrors:E,handleDragEnter:A,handleDragLeave:q,handleDragOver:P,handleDrop:V,handleFileChange:M,openFileDialog:J,getInputProps:Y}]},_=(t,e=2)=>{if(t===0)return"0 Bytes";const n=1024,g=e<0?0:e,o=["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"],m=Math.floor(Math.log(t)/Math.log(n));return Number.parseFloat((t/Math.pow(n,m)).toFixed(g))+o[m]},Ee=t=>{if(!t)return h.jsx(U,{className:"size-4 opacity-60"});const e=t.type,n=t.name;return e.includes("pdf")||n.endsWith(".pdf")||e.includes("word")||n.endsWith(".doc")||n.endsWith(".docx")?h.jsx(re,{className:"size-4 opacity-60"}):e.includes("zip")||e.includes("archive")||n.endsWith(".zip")||n.endsWith(".rar")?h.jsx(te,{className:"size-4 opacity-60"}):e.includes("excel")||n.endsWith(".xls")||n.endsWith(".xlsx")?h.jsx(se,{className:"size-4 opacity-60"}):e.includes("video/")?h.jsx(ye,{className:"size-4 opacity-60"}):e.includes("audio/")?h.jsx(ue,{className:"size-4 opacity-60"}):e.startsWith("image/")?h.jsx(ge,{className:"size-4 opacity-60"}):h.jsx(U,{className:"size-4 opacity-60"})};function je({value:t,onChange:e,placeholder:n="拖拽或点击上传",className:g,accept:o,maxSize:m=10*1024*1024}){const[{isDragging:l,errors:u},{handleDragEnter:c,handleDragLeave:a,handleDragOver:i,handleDrop:O,openFileDialog:p,getInputProps:f}]=Se({multiple:!1,maxSize:m,accept:o,onFilesChange:E=>{e(E[0]?.file instanceof File?E[0].file:null)}}),S=E=>{E.stopPropagation(),e(null)},d=t instanceof File&&t.size>0?t.name:null,y=t instanceof Blob&&t.size>0?t.size:null;return h.jsxs("div",{className:"flex flex-col gap-2",children:[h.jsxs("div",{role:"button",onClick:p,onDragEnter:c,onDragLeave:a,onDragOver:i,onDrop:O,"data-dragging":l||void 0,className:w("border-input hover:bg-accent/50 data-[dragging=true]:bg-accent/50 has-[input:focus]:border-ring has-[input:focus]:ring-ring/50 relative flex min-h-28 flex-col items-center justify-center rounded-xl border border-dashed p-4 transition-colors has-disabled:pointer-events-none has-disabled:opacity-50 has-[input:focus]:ring-[3px]",g),children:[h.jsx("input",{...f(),className:"sr-only","aria-label":"Upload files"}),!d&&h.jsxs("div",{className:"flex flex-col items-center justify-center text-center",children:[h.jsx("div",{className:"bg-background mb-2 flex size-11 shrink-0 items-center justify-center rounded-full border","aria-hidden":"true",children:h.jsx(ce,{className:"size-4 opacity-60"})}),h.jsx("p",{className:"mb-1.5 text-sm font-medium",children:n}),h.jsxs("p",{className:"text-muted-foreground text-xs",children:["最大 ",_(m)]})]}),d&&h.jsxs("div",{className:"bg-background flex w-full items-center justify-between gap-2 rounded-lg border p-2 pe-3",children:[h.jsxs("div",{className:"flex items-center gap-3 overflow-hidden",children:[h.jsx("div",{className:"flex aspect-square size-10 shrink-0 items-center justify-center rounded border",children:Ee(t instanceof File?t:null)}),h.jsxs("div",{className:"flex min-w-0 flex-col gap-0.5",children:[h.jsx("p",{className:"truncate text-[13px] font-medium",children:d}),y&&h.jsx("p",{className:"text-muted-foreground text-xs",children:_(y)})]})]}),h.jsx(K,{size:"icon",variant:"ghost",className:"text-muted-foreground/80 hover:text-foreground -me-2 size-8 shrink-0 hover:bg-transparent",onClick:S,"aria-label":"Remove file",children:h.jsx(Z,{className:"size-4","aria-hidden":"true"})})]})]}),u.length>0&&h.jsxs("div",{className:"text-destructive flex items-center gap-1 text-xs",role:"alert",children:[h.jsx(X,{className:"size-3 shrink-0"}),h.jsx("span",{children:u[0]})]})]})}const H="/attacker",Ce="/defender";async function Ne(t,e){if(!t.ok||!t.body){const u=(await t.json().catch(()=>({detail:[{msg:"请求失败，无法解析错误信息"}]}))).detail?.[0]?.msg||`HTTP error! status: ${t.status}`;e.onError?.({message:u}),e.onFinally?.();return}const n=t.body.getReader(),g=new TextDecoder;let o="";const m=l=>{if(!l.trim())return;const u=[];let c="message";for(const i of l.split(`
`))i.startsWith("event: ")?c=i.substring(7).trim():i.startsWith("data: ")&&u.push(i.substring(6).trim());if(u.length===0)return;const a=u.join(`
`);try{const i=JSON.parse(a);switch(c){case"start":e.onStart?.(i);break;case"message":e.onMessage?.(i);break;case"end":e.onEnd?.(i);break;case"error":e.onError?.(i);break;case"ping":break}}catch(i){console.error("Failed to parse SSE data JSON:",a,i)}};try{for(;;){const{done:l,value:u}=await n.read();u&&(o+=g.decode(u,{stream:!0}));const c=`

`;let a;for(;(a=o.indexOf(c))!==-1;){const i=o.substring(0,a);o=o.substring(a+c.length),m(i)}if(l){o&&m(o);break}}}catch(l){l instanceof Error&&l.name!=="AbortError"&&e.onError?.({message:l.message})}finally{e.onFinally?.()}}class xe{connections=new Map;createStream(e,n,g,o){this.closeStream(e);const m=new AbortController;this.connections.set(e,{controller:m,status:"connecting"});const l={onStart:u=>{const c=this.connections.get(e);c&&(c.status="streaming"),o.onStart?.(u)},onMessage:o.onMessage,onEnd:u=>{const c=this.connections.get(e);c&&(c.status="success"),o.onEnd?.(u)},onError:u=>{const c=this.connections.get(e);c&&(c.status="error"),o.onError?.(u)},onFinally:()=>{this.connections.delete(e),o.onFinally?.()}};return(async()=>{try{const u=await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g),signal:m.signal});await Ne(u,l)}catch(u){u instanceof Error&&(u.name!=="AbortError"&&(l.onError?.({message:u.message}),console.error("Failed to create stream:",u)),l.onFinally?.())}})(),m}createAttackerLogStream(e,n,g){const o=`attacker-log-${e}`,m=`${H}/v1/logs/log/completions`;return this.createStream(o,m,n,g)}createDefenderLogStream(e,n,g){const o=`defender-log-${e}`,m=`${Ce}/api/logs/stream`;return this.createStream(o,m,n,g)}createChatStream(e,n,g){const o=`chat-${e}`,m=`${H}/v1/chat/completions`;return this.createStream(o,m,n,g)}closeStream(e){const n=this.connections.get(e);n&&n.controller.abort()}closeAllStreamsForModel(e){this.closeStream(`log-${e}`),this.closeStream(`chat-${e}`)}}const j=new xe;function Me({className:t}){return h.jsx("div",{className:w(t,"inset-0 flex items-center justify-center "),children:h.jsx(fe,{className:"animate-spin",size:16,"aria-hidden":"true"})})}const ve=({logs:t,className:e})=>{const n=r.useRef(null),[g,o]=r.useState(!0),m=r.useRef(null),l=r.useCallback(()=>{n.current&&(n.current.scrollTop=n.current.scrollHeight)},[]);r.useEffect(()=>{g&&l()},[t,g,l]),r.useEffect(()=>{const c=n.current;if(!c)return;const a=()=>{m.current&&window.clearTimeout(m.current),c.scrollHeight-c.scrollTop-c.clientHeight<10?o(!0):(o(!1),m.current=window.setTimeout(()=>{o(!0)},5e3))};return c.addEventListener("scroll",a,{passive:!0}),()=>{c.removeEventListener("scroll",a),m.current&&window.clearTimeout(m.current)}},[l]);const u=c=>{switch(c?.toUpperCase()){case"INFO":return"text-primary";case"DEBUG":return"text-muted-foreground";case"WARNING":return"text-yellow-400";case"ERROR":return"text-destructive";case"CRITICAL":return"text-destructive font-bold animate-pulse";default:return"text-primary"}};return h.jsxs("div",{ref:n,className:w("bg-card text-foreground font-inter text-sm p-4 rounded-lg overflow-y-scroll",e),children:[h.jsx("div",{className:"space-y-1",children:t.map((c,a)=>h.jsxs("div",{className:"grid grid-cols-[auto_auto_1fr] items-baseline gap-x-2",children:[h.jsxs("span",{className:w("font-bold",u(c.level)),children:["[",c.level?.toUpperCase(),"]"]}),h.jsx("p",{className:"whitespace-pre-wrap break-words min-w-0",children:c.message})]},a))}),h.jsxs("div",{className:"flex items-center pt-2",children:[h.jsx("span",{className:"text-muted-foreground/70 mr-2 select-none",children:">"}),h.jsx("div",{className:"w-2 h-3 bg-primary animate-pulse"})]})]})};ve.displayName="Log";var b=(t=>(t.LOG="log",t.HISTORY="history",t.HEARTBEAT="heartbeat",t.ERROR="error",t.END="end",t.HISTORY_END="history_end",t))(b||{}),C=(t=>(t.DEBUG="DEBUG",t.INFO="INFO",t.WARNING="WARNING",t.ERROR="ERROR",t.CRITICAL="CRITICAL",t))(C||{}),k=(t=>(t.DISCONNECTED="disconnected",t.CONNECTING="connecting",t.CONNECTED="connected",t.ERROR="error",t.ENDED="ended",t))(k||{});function W(t){if(t.includes(C.DEBUG))return C.DEBUG;if(t.includes(C.INFO))return C.INFO;if(t.includes(C.WARNING))return C.WARNING;if(t.includes(C.ERROR))return C.ERROR;if(t.includes(C.CRITICAL))return C.CRITICAL}class be{eventSource=null;config;events;state=k.DISCONNECTED;reconnectAttempts=0;reconnectTimer=null;constructor(e,n){this.config={autoReconnect:!0,reconnectInterval:3e3,maxReconnectAttempts:5,...e},this.events=n}connect(){if(!(this.state===k.CONNECTED||this.state===k.CONNECTING)){this.setState(k.CONNECTING);try{this.eventSource=new EventSource(this.config.url),this.eventSource.onopen=()=>{console.log(`SSE连接已建立: ${this.config.url}`),this.setState(k.CONNECTED),this.reconnectAttempts=0},this.eventSource.onmessage=e=>{try{const n=JSON.parse(e.data);this.handleMessage(n)}catch(n){console.error("解析SSE消息失败:",n,e.data),this.events.onError(new Error(`消息解析失败: ${n}`))}},this.eventSource.onerror=e=>{console.error("SSE连接错误:",e),this.setState(k.ERROR),this.config.autoReconnect&&this.reconnectAttempts<(this.config.maxReconnectAttempts||5)&&this.scheduleReconnect()}}catch(e){console.error("创建SSE连接失败:",e),this.setState(k.ERROR),this.events.onError(e)}}}disconnect(){this.eventSource&&(this.eventSource.close(),console.log("SSE连接已关闭"),this.eventSource=null),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.setState(k.DISCONNECTED)}getState(){return this.state}setState(e){this.state!==e&&(this.state=e,this.events.onStateChange(e))}handleMessage(e){switch(e.type){case b.HISTORY_END:this.events.onHistoryEnd(e.history_count||0);break;case b.END:this.setState(k.ENDED);break;case b.ERROR:this.events.onError(new Error(e.message));break}this.events.onMessage(e)}scheduleReconnect(){this.reconnectTimer&&clearTimeout(this.reconnectTimer),this.reconnectAttempts++;const e=this.config.reconnectInterval||3e3;console.log(`SSE重连 (${this.reconnectAttempts}/${this.config.maxReconnectAttempts}) 将在 ${e}ms 后开始`),this.reconnectTimer=setTimeout(()=>{this.disconnect(),this.connect()},e)}}class ke{connections=new Map;messageCallbacks=new Map;stateCallbacks=new Map;createConnection(e,n,g,o){this.closeConnection(e);const m=new be(n,{onMessage:g,onStateChange:o,onError:l=>{console.error(`SSE连接 ${e} 错误:`,l)},onHistoryEnd:l=>{console.log(`SSE连接 ${e} 历史日志结束，共 ${l} 条`)}});return this.connections.set(e,m),this.messageCallbacks.set(e,g),this.stateCallbacks.set(e,o),m}getConnection(e){return this.connections.get(e)}closeConnection(e){const n=this.connections.get(e);n&&(n.disconnect(),this.connections.delete(e),this.messageCallbacks.delete(e),this.stateCallbacks.delete(e))}closeAllConnections(){for(const e of this.connections.keys())this.closeConnection(e)}getConnectionStates(){const e={};for(const[n,g]of this.connections)e[n]=g.getState();return e}}const $=new ke;function F(t,e){return t.type!==b.LOG&&t.type!==b.HISTORY?null:{id:`${t.timestamp}-${e}`,timestamp:t.timestamp,level:t.level||C.INFO,message:t.message,type:t.type===b.HISTORY?"history":"live",logger_name:t.logger_name,model_id:t.model_id,container_name:t.container_name}}const Re="/api",Le=t=>{const e=sessionStorage.getItem(`${t}-build-log`),[n,g]=r.useState(!1),[o,m]=r.useState(e?JSON.parse(e):[]),l=r.useRef(o);l.current=o;const[u,c]=r.useState(k.DISCONNECTED),a=`${t}-build-log`,i=r.useCallback(()=>{$.closeConnection(a)},[a]),O=r.useCallback(d=>{switch(d.type){case b.END:sessionStorage.setItem(`${t}-build-log`,JSON.stringify(l.current)),i();break}const y=F(d,l.current.length);y&&m(E=>[...E,y])},[i]),p=d=>{c(d)},f=r.useCallback(d=>{m([]);const y=`${Re}/logs/stream/model/${d}/build`;$.createConnection(a,{url:y},O,p).connect()},[a,O]);r.useEffect(()=>(o.length>0?g(!0):!S&&o.length===0&&g(!1),()=>{$.closeConnection(a)}),[]);const S=u===k.CONNECTING||u===k.CONNECTED;return r.useEffect(()=>{S&&g(!0)},[S]),{logs:o,isLogVisible:n,setIsLogVisible:g,isBuilding:S,connectionState:u,createBuildConnection:f,closeBuildConnection:i}},T={},z=new Set,L=()=>{z.forEach(t=>t())},Oe=(t,e)=>{const n=`${t}-${e}`,g="/api";if(T[n]&&(T[n].connectionState===k.CONNECTED||T[n].connectionState===k.CONNECTING))return;T[n]={logs:T[n]?.logs??[],connectionState:k.CONNECTING},L();const o=`${g}/logs/stream/model/${t}/container/${e}`,m=c=>{const a=T[n];if(!a)return;const i=F(c,a.logs.length);i&&(a.logs.push(i),L()),c.type===b.END&&$.closeConnection(n)},l=c=>{const a=T[n];a&&(a.connectionState=c,L())};$.createConnection(n,{url:o},m,l).connect()},De=(t,e)=>{const n=`${t}-${e}`;$.closeConnection(n)},Ie=t=>{Object.keys(T).forEach(e=>{e.startsWith(t)&&$.closeConnection(e)})},ze=()=>{const[,t]=r.useState(0);return r.useEffect(()=>{const e=()=>t(n=>n+1);return z.add(e),e(),()=>{z.delete(e)}},[]),{containerLogs:T,createContainerConnection:Oe,closeContainerConnection:De,closeAllContainerConnection:Ie}},Be=t=>{const[e,n]=r.useState([]),[g,o]=r.useState(!1),[m,l]=r.useState(null),u=r.useRef(null),c=r.useCallback(async i=>{if(!t)return;n([]),l(null),o(!0);const O={onStart:p=>{const{status:f}=p,S={type:b.LOG,timestamp:new Date().toISOString(),message:`攻击Agent SSE日志流已连接: ${f}`,level:C.INFO,logger_name:"attacker-agent",model_id:i.user_id},d=F(S,0);d&&n(y=>[...y,d]),console.log("攻击Agent SSE日志流已连接: ",p)},onMessage:p=>{const f=p,S=f.message.match(/\[ATTACK_SUCCESS_MARKER\](True|False)\[\/ATTACK_SUCCESS_MARKER\]/);if(S){const E=S[1]==="True";console.log(`攻击完成，结果: ${E?"成功":"失败"}`),a();return}const d=f.message&&typeof f.message=="string"&&W(f.message)||C.INFO,y={type:b.LOG,timestamp:f.timestamp,message:f.message,level:d,logger_name:"attacker-agent",model_id:i.user_id};n(E=>{const A=F(y,E.length);return A?[...E,A]:E})},onEnd:p=>{const{status:f}=p,S={type:b.LOG,timestamp:new Date().toISOString(),message:`攻击Agent SSE日志流已结束: ${f}`,level:C.INFO,logger_name:"attacker-agent",model_id:i.user_id};n(d=>{const y=F(S,d.length);return y?[...d,y]:d}),console.log("攻击Agent SSE日志流已结束: ",p)},onError:p=>{l(p.message);const f={type:b.LOG,timestamp:new Date().toISOString(),message:`攻击Agent SSE日志流错误: ${p.message}`,level:C.ERROR,logger_name:"attacker-agent",model_id:i.user_id};n(S=>{const d=F(f,S.length);return d?[...S,d]:S})},onFinally:()=>{o(!1),u.current=null}};u.current=j.createAttackerLogStream(t,i,O)},[t]),a=r.useCallback(()=>{t&&(j.closeStream(`attacker-log-${t}`),console.log("攻击Agent SSE日志流已关闭",t))},[t]);return r.useEffect(()=>()=>{a()},[a]),{logs:e,isStreaming:g,error:m,startLogs:c,stopLogs:a}},Ge=t=>{const[e,n]=r.useState([]),[g,o]=r.useState(!1),[m,l]=r.useState(null),u=r.useRef(null),c=r.useCallback(async i=>{if(!t)return;n([]),l(null),o(!0);const O={onStart:p=>{const{status:f,timestamp:S}=p,d={type:b.LOG,timestamp:S||new Date().toISOString(),message:`防御Agent SSE日志流已连接: ${f}`,level:C.INFO,logger_name:"defender-agent",model_id:i.model_id},y=F(d,0);y&&n(E=>[...E,y]),console.log("防御Agent SSE日志流已连接: ",p)},onMessage:p=>{const f=p,S=f.message&&typeof f.message=="string"&&W(f.message)||C.INFO,d={type:b.LOG,timestamp:f.timestamp,message:f.message,level:S,logger_name:"defender-agent",model_id:i.model_id};n(y=>{const E=F(d,y.length);return E?[...y,E]:y})},onEnd:p=>{const{status:f,timestamp:S}=p,d={type:b.LOG,timestamp:S||new Date().toISOString(),message:`防御Agent SSE日志流已结束: ${f}`,level:C.INFO,logger_name:"defender-agent",model_id:i.model_id};n(y=>{const E=F(d,y.length);return E?[...y,E]:y}),console.log("防御Agent SSE日志流已结束: ",p)},onError:p=>{const f=p.code?`${p.message} (代码: ${p.code})`:p.message;l(f);const S={type:b.LOG,timestamp:new Date().toISOString(),message:`防御Agent SSE日志流错误: ${f}`,level:C.ERROR,logger_name:"defender-agent",model_id:i.model_id};n(d=>{const y=F(S,d.length);return y?[...d,y]:d})},onFinally:()=>{o(!1),u.current=null}};u.current=j.createDefenderLogStream(t,i,O)},[t]),a=r.useCallback(()=>{t&&(j.closeStream(`defender-log-${t}`),console.log("防御Agent SSE日志流已关闭",t))},[t]);return r.useEffect(()=>()=>{a()},[a]),{logs:e,isStreaming:g,error:m,startLogs:c,stopLogs:a}};export{Ae as C,je as F,we as I,ve as L,C as S,Me as a,fe as b,Be as c,Ge as d,ze as e,j as f,Le as u};
