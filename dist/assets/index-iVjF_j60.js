import{j as e,c as U,n as K,r as x,R as $,B as g,p as I,b as Q}from"./index-jJ-r5mz2.js";import{u as V,a as y}from"./use-exercise-BlVckDcp.js";import{L as Y,I as f,C as T,F as Z,a as ee,u as se}from"./use-log-Bf_Sl--R.js";import{I as F}from"./input-DJh99Cqt.js";import{S as z,a as A,b as P,c as B,d as v}from"./select-Da-KtjNO.js";import{S as ae}from"./separator-CUn7s6rW.js";import{H as te,S as ne,T as ie,P as le,M as re}from"./theme-switch-Co7n-EGK.js";import{b as R,C as O,H as oe,a as ce,B as de,I as me,c as xe,d as ue,e as pe,f as he}from"./loading-button-Dxj-K1-v.js";import{C as fe,b as je,c as ge,a as be,e as ve}from"./card-BJCnjeSF.js";import{T as j}from"./trash-2-XLUJNpTV.js";import{P as G}from"./play-m6jg8ltQ.js";import{C as H}from"./circle-CW_Z5uWT.js";import{c as Ce}from"./index-DSZ_lwlW.js";import{u as Ne,C as ye}from"./confirm-dialog-Br2qhugx.js";import{u as Se,a as Te,o as W,F as we,b as w,c as k,d as _,e as D,f as E,s as C,k as ke}from"./form-BnuX5DB7.js";import{y as _e,z as De,B as Ee,C as Ie,E as Fe,F as Le,G as ze}from"./avatar-CVUMpbYi.js";import{b as Ae}from"./use-scenario-CWX--LNn.js";import{b as Pe,d as Be,e as Oe,f as Ge,h as He}from"./index-ZV2pxxac.js";import{u as Me,C as Ue}from"./use-dind-DrplGUN9.js";import"./circle-alert-CnzQp5Ap.js";import"./index-CT9bT4NP.js";import"./index-DC18PyZR.js";import"./index-Bdu6MxlU.js";import"./index-BkDHe_rU.js";import"./search-context-Dy6rVJYC.js";import"./command-BAzBGs10.js";import"./search-C8RdyhLB.js";import"./createReactComponent-DA_aFz5i.js";import"./index-DcoZsgCb.js";/**
 * @license lucide-react v0.523.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const $e=[["path",{d:"M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z",key:"i9b6wo"}],["line",{x1:"4",x2:"4",y1:"22",y2:"15",key:"1cm3nv"}]],M=Ce("flag",$e);function Ve({logs:s,isBuilding:n,className:t}){return e.jsxs("div",{className:U("flex flex-col rounded-lg border bg-card p-4 shadow-sm w-full",t),children:[e.jsxs("h3",{className:"mb-2 flex items-center text-lg font-semibold",children:[e.jsx(R,{className:"mr-2"}),"构建日志",n&&e.jsx("span",{className:"ml-3 animate-pulse text-sm text-primary",children:"正在构建演练镜像..."})]}),e.jsx("div",{className:"flex-1 overflow-hidden",children:e.jsx(Y,{logs:s,className:"w-full h-full"})})]})}const N={running:{label:"运行中",icon:ce,iconClassName:"text-green-500",actions:[{label:"进入靶机",icon:M,variant:"default",actionType:"submit_flag"},{label:"停止",icon:O,variant:"destructive",actionType:"stop"},{label:"查看报告",icon:M,variant:"link",actionType:"check_report"}]},stopped:{label:"已停止",icon:H,iconClassName:"text-gray-500",actions:[{label:"启动",icon:G,actionType:"start"},{label:"详细信息",icon:f,variant:"outline",actionType:"view_details"},{label:"删除",icon:j,variant:"destructive",actionType:"delete"}]},error:{label:"错误",icon:T,iconClassName:"text-red-500",actions:[{label:"详细信息",icon:f,variant:"outline",actionType:"view_details"},{label:"删除",icon:j,variant:"destructive",actionType:"delete"}]},building:{label:"构建中",icon:oe,iconClassName:"text-blue-500",actions:[{label:"停止构建",icon:O,variant:"outline",actionType:"force_stop_build"}]},pending:{label:"待处理",icon:H,iconClassName:"text-yellow-500",actions:[{label:"构建",icon:G,variant:"secondary",actionType:"build"},{label:"详细信息",icon:f,variant:"outline",actionType:"view_details"},{label:"删除",icon:j,variant:"destructive",actionType:"delete"}]},build_error:{label:"构建错误",icon:T,iconClassName:"text-red-500",actions:[{label:"详细信息",icon:f,variant:"outline",actionType:"view_details"},{label:"删除",icon:j,variant:"destructive",actionType:"delete"}]},runtime_error:{label:"运行错误",icon:T,iconClassName:"text-red-500",actions:[{label:"详细信息",icon:f,variant:"outline",actionType:"view_details"},{label:"删除",icon:j,variant:"destructive",actionType:"delete"}]}},X=K(s=>({isClickGenerateReport:!1,setClickGenerateReport:n=>s({isClickGenerateReport:n}),triggerReportGeneration:()=>{s({isClickGenerateReport:!1}),setTimeout(()=>{s({isClickGenerateReport:!0})},5e3)}}));function Re({state:s}){const n=N[s],t=n.icon;return e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full border px-2.5 py-0.5 text-xs font-semibold whitespace-nowrap",children:[e.jsx(t,{className:U("h-3 w-3",n.iconClassName)}),n.label]})}function We({state:s,onAction:n,pendingAction:t,exerciseId:a}){const{isClickGenerateReport:l}=X(),r=N[s];if(r.component){const i=r.component;return e.jsx(i,{})}return r.actions?e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:r.actions.map(i=>{const c=i.icon;return i.actionType==="check_report"&&!l?null:e.jsxs(de,{variant:i.variant||"default",size:"sm",isLoading:t===i.actionType,onClick:()=>n(i.actionType),children:[e.jsx(c,{className:"mr-2 h-4 w-4"}),i.label]},i.label)})}):e.jsx("div",{className:"min-h-[36px]"})}function Xe({name:s,description:n,state:t,onAction:a,pendingAction:l,uuid:r}){return e.jsxs(fe,{className:"h-full flex flex-col",children:[e.jsx(je,{className:"",children:e.jsxs("div",{className:"flex justify-between gap-3",children:[e.jsx(ge,{className:"truncate max-w-[50%]",title:s,children:s}),e.jsx(Re,{state:t})]})}),e.jsxs(be,{className:"flex-grow pb-2",children:[e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-3",children:n}),e.jsxs("p",{className:"text-sm text-muted-foreground line-clamp-3",children:["UUID:",r]})]}),e.jsx(ve,{className:"pt-2 mt-auto",children:e.jsx(We,{state:t,onAction:a,pendingAction:l,exerciseId:r})})]})}const q=$.createContext(null);function qe({children:s}){const[n,t]=Ne(null),[a,l]=x.useState(null);return e.jsx(q.Provider,{value:{open:n,setOpen:t,currentRow:a,setCurrentRow:l},children:s})}const S=()=>{const s=$.useContext(q);if(!s)throw new Error("useExercisesDialog has to be used within <ExercisesDialogContext>");return s},Je=W({name:C().min(1,"演练名称必填"),description:C().min(1,"演练描述必填")}),Ke=W({name:C().min(1,"演练名称必填"),description:C().min(1,"演练描述必填"),target_file:ke(Blob,{message:"请上传靶机压缩包"}).refine(s=>s.size>0,"请上传靶机压缩包")});function J({open:s,onOpenChange:n,currentRow:t}){const a=!!t,{createExerciseAsync:l}=V(),{updateExerciseAsync:r}=y(a?t.uuid:""),i=Se({resolver:Te(a?Je:Ke),defaultValues:a?{name:t.name,description:t.description}:{name:"",description:"",target_file:void 0}}),c=o=>{a&&t?r({modelId:t.uuid,data:o}):l(o),n(!1),i.reset()};return e.jsx(_e,{open:s,onOpenChange:o=>{n(o),i.reset()},children:e.jsxs(De,{className:"flex flex-col h-full",children:[e.jsxs(Ee,{className:"text-left",children:[e.jsxs(Ie,{children:[a?"更新":"创建"," 演练"]}),e.jsxs(Fe,{children:[a?"更新演练信息":"添加新演练信息","完成后点击保存."]})]}),e.jsx(we,{...i,children:e.jsxs("form",{id:"scenarios-form",onSubmit:i.handleSubmit(c),className:"space-y-5 px-4 min-h-0  overflow-y-auto",children:[e.jsx(w,{control:i.control,name:"name",render:({field:o})=>e.jsxs(k,{className:"space-y-1",children:[e.jsx(_,{children:"演练名称"}),e.jsx(D,{children:e.jsx(F,{...o,placeholder:"请输入本次演练名称"})}),e.jsx(E,{})]})}),e.jsx(w,{control:i.control,name:"description",render:({field:o})=>e.jsxs(k,{className:"space-y-1",children:[e.jsx(_,{children:"演练描述"}),e.jsx(D,{children:e.jsx(F,{...o,placeholder:"请输入演练描述"})}),e.jsx(E,{})]})}),!a&&e.jsx(e.Fragment,{children:e.jsx(w,{control:i.control,name:"target_file",render:({field:o})=>e.jsxs(k,{className:"space-y-1",children:[e.jsx(_,{children:"演练靶机压缩包"}),e.jsx(D,{children:e.jsx(Z,{value:o.value,onChange:o.onChange,placeholder:"请上传靶机压缩包",accept:".zip,.rar,.7z,.tar,.gz"})}),e.jsx(E,{})]})})})]})}),e.jsxs(Le,{className:"gap-2",children:[e.jsx(ze,{asChild:!0,children:e.jsx(g,{variant:"outline",children:"取消"})}),e.jsx(g,{form:"scenarios-form",type:"submit",children:"保存"})]})]})})}function Qe({open:s,onOpenChange:n,currentRow:t}){const a=t.uuid,[l,r]=x.useState(!1);Me(a);const{triggerReportGeneration:i}=X(),{targetContainerName:c,portMap:o}=Ae(a),u=c?o.get(c)?.targetEntrancePort:void 0,d=u?`http://localhost:${u}`:void 0;x.useEffect(()=>{d&&r(!0)},[d]);const p=()=>{I("正在生成报告，请稍后"),n(!1),i()};return e.jsx(Pe,{open:s,onOpenChange:n,children:e.jsxs(Be,{className:"flex flex-col gap-4",children:[e.jsx(Oe,{children:e.jsxs(Ge,{children:["练习：",t.name]})}),e.jsxs("div",{className:"flex flex-col gap-4",children:[e.jsxs("p",{className:"text-muted-foreground text-sm",children:["题目描述：",e.jsx("span",{className:"line-clamp-3",title:t.description,children:t.description})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[l?d?`靶机入口URL：${d}`:"抱歉，靶机入口URL获取失败":e.jsx(ee,{}),e.jsx("button",{className:"hover:bg-muted rounded-md p-2",onClick:()=>{d&&(navigator.clipboard.writeText(d),I("靶机入口URL已复制到剪贴板"))},children:e.jsx(Ue,{size:18})})]})]}),e.jsxs("div",{className:"flex items-start gap-3 p-3 bg-blue-50 dark:bg-blue-950/20 border border-blue-200 dark:border-blue-800 rounded-lg",children:[e.jsx(f,{className:"w-5 h-5 text-blue-600 dark:text-blue-400 mt-0.5 flex-shrink-0"}),e.jsx("p",{className:"text-sm text-blue-800 dark:text-blue-200 leading-relaxed",children:"后端服务会自动监听指挥官的进攻指令，指挥官进攻完毕过后，就可以开始点击进行分析了"})]}),e.jsx(He,{children:e.jsx(g,{type:"submit",onClick:()=>p(),children:"开始分析"})})]})})}function Ye({currentRow:s,open:n}){const{setOpen:t,setCurrentRow:a}=S(),{deleteExerciseAsync:l}=y(s.uuid);return e.jsxs(e.Fragment,{children:[e.jsx(J,{open:n==="update",onOpenChange:()=>{t("update"),setTimeout(()=>{a(null)},500)},currentRow:s},`exercise-update-${s.uuid}`),e.jsx(Qe,{open:n==="submit_flag",onOpenChange:()=>{t("submit_flag"),setTimeout(()=>{a(null)},500)},currentRow:s},`exercise-submit-flag-${s.uuid}`),e.jsx(ye,{destructive:!0,open:n==="delete",onOpenChange:()=>{t("delete")},handleConfirm:()=>{t(null),setTimeout(()=>{a(null)},500),I(`演练${s.name}已删除`),l({modelId:s.uuid})},className:"max-w-md",title:`删除场景: ${s.name} ?`,desc:e.jsxs(e.Fragment,{children:["你确定要删除演练: ",e.jsx("strong",{children:s.name})," ?",e.jsx("br",{}),"此操作无法撤销."]}),confirmText:"删除"},"exercise-delete")]})}function Ze(){const{open:s,setOpen:n,currentRow:t}=S();return e.jsxs(e.Fragment,{children:[e.jsx(J,{open:s==="create",onOpenChange:()=>n("create")},"exercise-create"),t&&e.jsx(Ye,{currentRow:t,open:s})]})}function es(){const{setOpen:s}=S();return e.jsx("div",{className:"flex gap-2",children:e.jsxs(g,{className:"space-x-1",onClick:()=>s("create"),children:[e.jsx("span",{children:"创建演练"})," ",e.jsx(me,{size:18})]})})}const ss=(s,n,t)=>{const{exercise:a,updateState:l,isUpdatingState:r}=y(s),{setOpen:i,setCurrentRow:c}=S(),o=Q(),[u,d]=x.useState(null);return x.useEffect(()=>{r||d(null)},[r]),{handleAction:x.useCallback(h=>{if(a)switch(h){case"submit_flag":c(a),i("submit_flag");break;case"check_report":o({to:"/exercises/$exerciseId/report",params:{exerciseId:s}});break;case"build":c(a),d("build"),l({modelId:s,data:{action:h}}),n(s);break;case"force_stop_build":c(a),d("force_stop_build"),l({modelId:s,data:{action:h}});break;case"start":c(a),d("start"),l({modelId:s,data:{action:h}});break;case"stop":c(a),d("stop"),l({modelId:s,data:{action:h}});break;case"delete":c(a),t(),i("delete");break;case"view_details":c(a),i("update");break}},[s,l,i,a,c,o,n,t]),pendingAction:u}};function as(){const{exercises:s}=V(),[n,t]=x.useState("ascending"),[a,l]=x.useState("all"),[r,i]=x.useState(""),{logs:c,isBuilding:o,createBuildConnection:u,closeBuildConnection:d,isLogVisible:p,setIsLogVisible:h}=se("exercise"),L=s?s.sort((m,b)=>n==="ascending"?m.name.localeCompare(b.name):b.name.localeCompare(m.name)).filter(m=>a==="all"?!0:m.state===a).filter(m=>m.name.toLowerCase().includes(r.toLowerCase())):[];return e.jsxs(qe,{children:[e.jsxs(te,{fixed:!0,children:[e.jsx(ne,{}),e.jsxs("div",{className:"ml-auto flex items-center space-x-4",children:[e.jsx(ie,{}),e.jsx(le,{})]})]}),e.jsxs(re,{fixed:!0,className:"min-h-0 overflow-y-auto",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold tracking-tight",children:"智能演练基地"}),e.jsx("p",{className:"text-muted-foreground",children:"AI Agent将根据你的进攻指令，自动化生成演练评估报告"})]}),e.jsx(es,{})]}),e.jsxs("div",{className:"my-4 flex items-end justify-between sm:my-0 sm:items-center",children:[e.jsxs("div",{className:"flex flex-col gap-4 sm:my-4 sm:flex-row",children:[e.jsx(F,{placeholder:"搜索演练名称关键词...",className:"h-9 w-40 lg:w-[250px]",value:r,onChange:m=>i(m.target.value)}),e.jsxs(z,{value:a,onValueChange:l,children:[e.jsx(A,{className:"w-36",children:e.jsx(P,{children:a==="all"?"所有演练容器":N[a].label})}),e.jsxs(B,{children:[e.jsx(v,{value:"all",children:"所有场景容器"}),Object.entries(N).map(([m,b])=>e.jsx(v,{value:m,children:b.label},m))]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>h(!p),children:[e.jsx(R,{size:16,className:"mr-2"}),p?"隐藏日志":"显示日志",e.jsx(xe,{size:16,className:`ml-2 transition-transform ${p?"rotate-180":""}`})]}),e.jsxs(z,{value:n,onValueChange:t,children:[e.jsx(A,{className:"w-16",children:e.jsx(P,{children:e.jsx(ue,{size:18})})}),e.jsxs(B,{align:"end",children:[e.jsx(v,{value:"ascending",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(pe,{size:16}),e.jsx("span",{children:"升序"})]})}),e.jsx(v,{value:"descending",children:e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx(he,{size:16}),e.jsx("span",{children:"降序"})]})})]})]})]})]}),e.jsx(ae,{className:"shadow-sm"}),e.jsxs("div",{className:"flex flex-1 flex-col gap-4 py-4",children:[p&&e.jsx(Ve,{logs:c,isBuilding:o,className:"h-80"}),L.length>0?e.jsx("ul",{className:"grid gap-4 overflow-auto pb-16 md:grid-cols-1 lg:grid-cols-2 xl:grid-cols-3",children:L.map(m=>e.jsx("li",{children:e.jsx(ts,{exercise:m,createBuildConnection:u,closeBuildConnection:d})},m.uuid))}):e.jsx("div",{className:"text-muted-foreground",children:"没有找到创建好的演练，请点击右上角创建演练"})]})]}),e.jsx(Ze,{})]})}function ts({exercise:s,createBuildConnection:n,closeBuildConnection:t}){const{status:a}=y(s.uuid),{handleAction:l,pendingAction:r}=ss(s.uuid,n,t);return a&&(s.state=a.state),e.jsx(Xe,{...s,onAction:l,pendingAction:r})}const Ls=as;export{Ls as component};
